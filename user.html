<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מערכת נכסלים - עדכון</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="layout-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header"><h2 id="welcome-message"></h2></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a data-panel="presence" class="active">דיווח נוכחות</a></li>
                    <li><a data-panel="shabbat">דיווח שבת</a></li>
                    <li><a data-panel="emergency">דיווח חירום</a></li>
                    <li><a data-panel="password">שינוי סיסמה</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><a class="button-modern" data-action="logout">התנתקות</a></div>
        </aside>
        <main class="main-content">
            <div id="presence-panel" class="content-panel active"><div class="card"><h4>דיווח נוכחות (זום)</h4><button class="button-modern btn-presence" data-action="submit-presence" data-status="מחובר">אני מחובר</button><div class="input-group" style="margin-top: 20px;"><input type="text" id="presenceCustomInput" placeholder="או: דיווח נוכחות אחר"></div><button class="button-modern btn-presence" data-action="submit-presence-custom">שלח דיווח אחר</button><div id="presenceMessage" class="message" style="display:none;"></div></div></div>
            <div id="shabbat-panel" class="content-panel"><div class="card"><h4>דיווח סטטוס שבת</h4><div class="input-group"><input type="text" id="shabbatStatusInput" placeholder="היכן אתה בשבת?"></div><button class="button-modern btn-shabbat" data-action="submit-shabbat">עדכן</button><div id="shabbatMessage" class="message" style="display:none;"></div></div></div>
            <div id="emergency-panel" class="content-panel"><div class="card"><h4>דיווח חירום</h4><div class="input-group"><input type="text" id="emergencyLocationInput" placeholder="מיקום נוכחי"></div><div class="input-group"><input type="text" id="emergencyStatusInput" placeholder="סטטוס אישי"></div><button class="button-modern btn-emergency" data-action="submit-emergency">שלח</button><div id="emergencyMessage" class="message" style="display:none;"></div></div></div>
            <div id="password-panel" class="content-panel"><div class="card"><h4>שינוי סיסמה</h4><div class="input-group"><input type="password" id="newPasswordInput" placeholder="סיסמה חדשה"></div><button class="button-modern btn-password" data-action="change-password">שנה</button><div id="passwordMessage" class="message" style="display:none;"></div></div></div>
        </main>
    </div>
    <script src="script.js"></script>
    <script>
        const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser) window.location.href = 'index.html';
        document.getElementById('welcome-message').textContent = 'שלום, ' + loggedInUser.name;

        document.body.addEventListener('click', async (event) => {
            const target = event.target;
            const action = target.dataset.action;
            if (!action) {
                if (target.parentElement.dataset.panel) showPanel(target.parentElement.dataset.panel, target.parentElement);
                else if (target.dataset.panel) showPanel(target.dataset.panel, target);
                return;
            };

            setLoading(target, true);
            let data, messageDivId;
            switch (action) {
                case 'submit-presence':
                    await sendReport({ updateType: 'נוכחות', reportData: target.dataset.status }, 'presenceMessage', target);
                    break;
                case 'submit-presence-custom':
                    const customStatus = document.getElementById('presenceCustomInput').value.trim();
                    if (!customStatus) { alert("אנא כתוב דיווח."); setLoading(target, false); return; }
                    await sendReport({ updateType: 'נוכחות', reportData: customStatus }, 'presenceMessage', target);
                    break;
                case 'submit-shabbat':
                    const shabbatStatus = document.getElementById('shabbatStatusInput').value.trim();
                    if (!shabbatStatus) { alert("אנא מלא את סטטוס השבת."); setLoading(target, false); return; }
                    await sendReport({ updateType: 'שבת', reportData: shabbatStatus }, 'shabbatMessage', target);
                    break;
                case 'submit-emergency':
                    const location = document.getElementById('emergencyLocationInput').value.trim();
                    const status = document.getElementById('emergencyStatusInput').value.trim();
                    if (!location || !status) { alert("אנא מלא את שני השדות."); setLoading(target, false); return; }
                    await sendReport({ updateType: 'חירום', reportData: location, emergencyStatus: status }, 'emergencyMessage', target);
                    break;
                case 'change-password':
                    const newPassword = document.getElementById('newPasswordInput').value;
                    if (!newPassword || newPassword.length < 4) { showMessage('passwordMessage', "הסיסמה חייבת להכיל לפחות 4 תווים.", true); setLoading(target, false); return; }
                    const response = await apiCall('changeUserPassword', { userEmail: loggedInUser.email, newPassword });
                    const msg = response.success ? `${loggedInUser.name}, ${response.message}` : response.message;
                    showMessage('passwordMessage', msg, !response.success);
                    if (response.success) document.getElementById('newPasswordInput').value = '';
                    break;
                case 'logout':
                    logout();
                    break;
            }
            if (action !== 'change-password') setLoading(target, false);
        });

        function showPanel(panelId, clickedLink) {
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panelId + '-panel').classList.add('active');
            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
            clickedLink.classList.add('active');
        }

        async function sendReport(data, messageDivId, buttonElement) {
            data.userEmail = loggedInUser.email;
            data.userName = loggedInUser.name;
            showMessage(messageDivId, "שולח דיווח...", false);
            const response = await apiCall('logUserStatus', data);
            const msg = response.success ? `${loggedInUser.name}, ${response.message}` : response.message;
            showMessage(messageDivId, msg, !response.success);
        }
    </script>
</body>
</html>