<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מערכת נכסלים - ניהול</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="admin-body">
    <div id="app-container">
        <!-- החלק העליון של הטפסים נשאר זהה -->
        <div class="top-bar">
            <div class="top-bar-header">
                <h1 id="admin-welcome">דשבורד מנהל</h1>
                <button class="button-modern logout-btn" data-action="logout">התנתקות</button>
            </div>
            <hr>
            <div class="controls-row">
                <div class="control-group">
                    <label for="date-picker">תאריך לדוחות:</label>
                    <input type="date" id="date-picker">
                    <button class="button-modern btn-presence" data-action="fetch-reports" data-filter="נוכחות">הצג נוכחות</button>
                    <button class="button-modern btn-shabbat" data-action="fetch-reports" data-filter="שבת">הצג סטטוס שבת</button>
                    <button class="button-modern btn-emergency" data-action="fetch-reports" data-filter="חירום">הצג סטטוס חירום</button>
                    <button class="button-modern" id="export-excel-btn" style="display:none">📥 הורד לאקסל</button>
                </div>
            </div>
            <hr>
            <div class="controls-row">
                <form id="manual-update-form" class="control-group">
                    <label>עדכון ידני:</label>
                    <select id="user-select" required><option value="">בחר משתמש...</option></select>
                    <input type="text" id="manual-status" placeholder="נתון ראשי" required>
                    <input type="text" id="manual-status-secondary" placeholder="נתון משני (לחירום)" style="display:none;">
                    <select id="manual-update-type" required>
                        <option value="נוכחות">נוכחות</option>
                        <option value="שבת">שבת</option>
                        <option value="חירום">חירום</option>
                    </select>
                    <button type="submit" class="button-modern btn-update">עדכן</button>
                </form>
            </div>
        </div>
        <div class="content-table">
            <h3 id="report-title" style="text-align:center; padding-bottom: 20px; color: #374151;"></h3>
            <table id="report-table" class="report-table">
                <thead></thead>
                <tbody><tr><td colspan="4" style="text-align: center; padding: 40px;">בחר דוח להצגה.</td></tr></tbody>
            </table>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser || loggedInUser.role !== 'Admin') {
            window.location.href = 'index.html';
        }

        let currentReportData = [];
        let currentFilter = '';
        let currentDate = '';

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('admin-welcome').textContent = 'שלום, ' + loggedInUser.name;
            document.getElementById('date-picker').valueAsDate = new Date();
            populateUserList();
        });

        document.body.addEventListener('click', async (event) => {
            const action = event.target.dataset.action;
            if (action === 'fetch-reports') await fetchReports(event.target);
            if (action === 'logout') logout();
        });

        document.getElementById('manual-update-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const data = {
                targetName: form.querySelector('#user-select').value,
                reportData: form.querySelector('#manual-status').value,
                emergencyStatus: form.querySelector('#manual-status-secondary').value,
                updateType: form.querySelector('#manual-update-type').value,
                adminName: loggedInUser.name
            };
            if (!data.targetName || !data.reportData) return alert('יש למלא שם ונתון ראשי.');

            const button = form.querySelector('button[type="submit"]');
            setLoading(button, true);
            const response = await apiCall('adminUpdateUserStatus', data);
            alert(response.message);
            if (response.success) {
                form.reset();
                document.getElementById('manual-status-secondary').style.display = 'none';
            }
            setLoading(button, false);
        });

        document.getElementById('manual-update-type').addEventListener('change', (e) => {
            document.getElementById('manual-status-secondary').style.display = (e.target.value === 'חירום') ? 'inline-block' : 'none';
        });

        document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);

        async function fetchReports(button) {
            currentFilter = button.dataset.filter;
            currentDate = document.getElementById('date-picker').value;

            setLoading(button, true);
            document.getElementById('report-title').innerText = `טוען דוח ${currentFilter}...`;
            document.querySelector('#report-table tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;">טוען...</td></tr>';
            
            const response = await apiCall('getReportsData', { filterType: currentFilter, dateString: currentDate });
            setLoading(button, false);

            if (response.success) {
                currentReportData = response.data;
                displayReport();
            } else {
                document.getElementById('report-title').innerText = 'שגיאה בהעלאת הדוח';
                document.querySelector('#report-table tbody').innerHTML = `<tr><td colspan="4" style="text-align:center;">${response.message}</td></tr>`;
            }
        }
        
        // =================================================================
        //  גרסה סופית ו"חסינת-טעויות" של פונקציית התצוגה
        // =================================================================
        function displayReport() {
            const tableHead = document.querySelector('#report-table thead');
            const tableBody = document.querySelector('#report-table tbody');

            let columns;
            if (currentFilter === 'חירום') {
                columns = ['שם', 'מיקום', 'סטטוס', 'זמן עדכון'];
            } else if (currentFilter === 'שבת') {
                columns = ['שם', 'מיקום', 'זמן עדכון'];
            } else { // נוכחות
                columns = ['שם', 'סטטוס', 'זמן עדכון'];
            }
            tableHead.innerHTML = '<tr>' + columns.map(c => `<th>${c}</th>`).join('') + '</tr>';
            
            tableBody.innerHTML = ''; 

            currentReportData.forEach(user => {
                const tr = document.createElement('tr');
                const userDidNotReport = !user.timestamp;
                if (userDidNotReport) {
                    tr.classList.add('not-reported');
                }

                const createCell = (text) => {
                    const td = document.createElement('td');
                    // בדיקה מפורשת כדי למנוע הצגה של 'null' או 'undefined'
                    if (text === null || typeof text === 'undefined') {
                        td.textContent = '';
                    } else {
                        td.textContent = text;
                    }
                    tr.appendChild(td);
                };

                // הרכבת השורה - תא אחר תא
                createCell(user.name);

                if (currentFilter === 'חירום') {
                    let locationText = '';
                    let statusText = '';
                    
                    if (userDidNotReport) {
                        locationText = 'לא התקבל דיווח';
                    } else {
                        // בדיקה מפורשת: אם השרת פירק את המידע, נשתמש בו. אם לא, נשתמש במידע הגולמי.
                        locationText = user.location || user.reportData;
                        statusText = user.status;
                    }
                    createCell(locationText);
                    createCell(statusText);
                } else {
                    // לוגיקה פשוטה לדוחות רגילים
                    createCell(userDidNotReport ? 'לא התקבל דיווח' : user.reportData);
                }
                
                createCell(user.timestamp);

                tableBody.appendChild(tr);
            });

            document.getElementById('report-title').innerText = `דוח ${currentFilter} לתאריך ${new Date(currentDate).toLocaleDateString('he-IL')}`;
            document.getElementById('export-excel-btn').style.display = 'inline-block';
        }

        async function populateUserList() {
            const response = await apiCall('getAllUserNames');
            if (response.success) {
                const userSelect = document.getElementById('user-select');
                response.data.forEach(name => {
                    const option = new Option(name, name);
                    userSelect.add(option);
});
            }
        }
        
        function exportToExcel() {
            if (!currentReportData || currentReportData.length === 0) return;
            const dataForSheet = currentReportData.map(user => {
                const userDidNotReport = !user.timestamp;
                if (currentFilter === 'חירום') {
                    const locationText = user.location || user.reportData;
                    const statusText = user.status;
                    return {
                        'שם': user.name,
                        'מיקום': userDidNotReport ? 'לא התקבל דיווח' : locationText,
                        'סטטוס': userDidNotReport ? '' : statusText,
                        'זמן עדכון': user.timestamp || ''
                    };
                } else {
                     let mainColumnTitle = (currentFilter === 'שבת') ? 'מיקום' : 'סטטוס';
                     return {
                        'שם': user.name,
                        [mainColumnTitle]: userDidNotReport ? 'לא התקבל דיווח' : user.reportData,
                        'זמן עדכון': user.timestamp || ''
                    };
                }
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(dataForSheet);
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, `דוח_${currentFilter}_${currentDate}.xlsx`);
        }
    </script>
</body>
</html>
