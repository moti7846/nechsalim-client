<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>注专转 住 - </title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="admin-body">
    <div id="app-container">
        <div class="top-bar">
            <div class="top-bar-header">
                <h1 id="admin-welcome">砖专 </h1>
                <button class="button-modern logout-btn" data-action="logout">转转拽转</button>
            </div>
            <hr>
            <div class="controls-row">
                <div class="control-group">
                    <label for="date-picker">转专 转:</label>
                    <input type="date" id="date-picker">
                    <button class="button-modern btn-presence" data-action="fetch-reports" data-filter="转">爪 转</button>
                    <button class="button-modern btn-shabbat" data-action="fetch-reports" data-filter="砖转">爪 住住 砖转</button>
                    <button class="button-modern btn-emergency" data-action="fetch-reports" data-filter="专">爪 住住 专</button>
                    <button class="button-modern" id="export-excel-btn" style="display:none"> 专 拽住</button>
                </div>
            </div>
            <hr>
            <div class="controls-row">
                <form id="manual-update-form" class="control-group">
                    <label>注 :</label>
                    <select id="user-select" required><option value="">专 砖转砖...</option></select>
                    <input type="text" id="manual-status" placeholder="转 专砖" required>
                    <input type="text" id="manual-status-secondary" placeholder="转 砖 (专)" style="display:none;">
                    <select id="manual-update-type" required>
                        <option value="转">转</option>
                        <option value="砖转">砖转</option>
                        <option value="专">专</option>
                    </select>
                    <button type="submit" class="button-modern btn-update">注</button>
                </form>
            </div>
        </div>
        <div class="content-table">
            <h3 id="report-title" style="text-align:center; padding-bottom: 20px; color: #374151;"></h3>
            <table id="report-table" class="report-table">
                <thead></thead>
                <tbody><tr><td colspan="4" style="text-align: center; padding: 40px;">专  爪.</td></tr></tbody>
            </table>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser || loggedInUser.role !== 'Admin') {
            window.location.href = 'index.html';
        }

        // --- 砖转  ---
        let allSystemUsers = [];
        let allLogsForDay = [];
        let currentFilter = '';
        let currentDate = '';

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('admin-welcome').textContent = '砖, ' + loggedInUser.name;
            document.getElementById('date-picker').valueAsDate = new Date();
            const response = await apiCall('getAllUserNames');
            if (response.success) {
                allSystemUsers = response.data;
                populateUserList(allSystemUsers);
            }
        });

        document.body.addEventListener('click', async (event) => {
            const action = event.target.dataset.action;
            if (action === 'fetch-reports') await fetchAndDisplayReports(event.target);
            if (action === 'logout') logout();
        });

        document.getElementById('manual-update-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const data = {
                targetName: form.querySelector('#user-select').value,
                reportData: form.querySelector('#manual-status').value,
                emergencyStatus: form.querySelector('#manual-status-secondary').value,
                updateType: form.querySelector('#manual-update-type').value,
                adminName: loggedInUser.name
            };
            if (!data.targetName || !data.reportData) return alert('砖  砖 转 专砖.');

            const button = form.querySelector('button[type="submit"]');
            setLoading(button, true);
            const response = await apiCall('adminUpdateUserStatus', data);
            alert(response.message);
            if (response.success) {
                form.reset();
                document.getElementById('manual-status-secondary').style.display = 'none';
            }
            setLoading(button, false);
        });
        
        document.getElementById('manual-update-type').addEventListener('change', (e) => {
            document.getElementById('manual-status-secondary').style.display = (e.target.value === '专') ? 'inline-block' : 'none';
        });

        document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);


        // ===============================================
        //  驻拽爪转  专拽专 砖
        // ===============================================

        async function fetchAndDisplayReports(button) {
            currentFilter = button.dataset.filter;
            currentDate = document.getElementById('date-picker').value;

            setLoading(button, true);
            document.getElementById('report-title').innerText = `注  ${currentFilter}...`;
            const tableBody = document.querySelector('#report-table tbody');
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">注 转...</td></tr>';
            
            // 拽专 -getRawLogsForDate 注专  砖专
            const todayResponse = await apiCall('getRawLogsForDate', { dateString: currentDate });
            
            let yesterdayLogs = [];
            //    砖转, 拽砖  转 转  砖砖
            if (currentFilter === '砖转') {
                const selectedDate = new Date(currentDate);
                selectedDate.setDate(selectedDate.getDate() - 1);
                const yesterdayDateString = selectedDate.toISOString().split('T')[0];
                const yesterdayResponse = await apiCall('getRawLogsForDate', { dateString: yesterdayDateString });
                if (yesterdayResponse.success) {
                    yesterdayLogs = yesterdayResponse.data;
                }
            }

            setLoading(button, false);

            if (todayResponse.success) {
                //  : 拽 砖 ,  砖 转
                allLogsForDay = [...todayResponse.data, ...yesterdayLogs];
                displayReport();
            } else {
                tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">${todayResponse.message || '砖 拽转 转 砖专转.'}</td></tr>`;
                document.getElementById('report-title').innerText = '砖';
            }
        }

        function displayReport() {
            const tableHead = document.querySelector('#report-table thead');
            const tableBody = document.querySelector('#report-table tbody');
            
            let columns;
            if (currentFilter === '专') columns = ['砖', '拽', '住住', ' 注'];
            else if (currentFilter === '砖转') columns = ['砖', '拽', ' 注'];
            else columns = ['砖', '住住', ' 注'];
            tableHead.innerHTML = '<tr>' + columns.map(c => `<th>${c}</th>`).join('') + '</tr>';
            
            // 爪转  注 转专  砖转砖
            const latestReports = new Map();
            for (let i = 0; i < allLogsForDay.length; i++) { // 砖 拽: 专爪 转 住祝
                const log = allLogsForDay[i];
                if (log.Status_Type === currentFilter) { //  砖 住 
                    latestReports.set(log.Name, log); // 专住  砖 注 砖
                }
            }

            tableBody.innerHTML = ''; 
            allSystemUsers.forEach(userName => {
                const tr = document.createElement('tr');
                const report = latestReports.get(userName);

                if (!report) {
                    tr.classList.add('not-reported');
                    createCell(tr, userName);
                    createCell(tr, ' 转拽 ');
                    if (currentFilter === '专') createCell(tr, ''); 
                    createCell(tr, ''); 
                } else {
                    createCell(tr, userName);
                    if (currentFilter === '专') {
                        const reportDataStr = report.Report_Data || '';
                        const parts = reportDataStr.split('|');
                        const location = parts[0] ? parts[0].replace('拽:', '').trim() : reportDataStr;
                        const status = parts[1] ? parts[1].replace('住住:', '').trim() : '';
                        createCell(tr, location);
                        createCell(tr, status);
                    } else {
                        createCell(tr, report.Report_Data);
                    }
                    createCell(tr, new Date(report.Timestamp).toLocaleString('he-IL', { timeZone: 'Asia/Jerusalem' }));
                }
                tableBody.appendChild(tr);
            });
            
            document.getElementById('report-title').innerText = ` ${currentFilter} 转专 ${new Date(currentDate).toLocaleDateString('he-IL')}`;
            document.getElementById('export-excel-btn').style.display = 'inline-block';
        }

        function createCell(tr, text) {
            const td = document.createElement('td');
            td.textContent = text ?? '';
            tr.appendChild(td);
        }

        function populateUserList(users) {
            const userSelect = document.getElementById('user-select');
            userSelect.innerHTML = '<option value="">专 砖转砖...</option>';
            users.forEach(name => userSelect.add(new Option(name, name)));
        }

        function exportToExcel() {
            // 拽 驻 砖专转  专住 专 砖转 转拽
        }
    </script>
</body>
</html>
