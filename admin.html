<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××¢×¨×›×ª × ×›×¡×œ×™× - × ×™×”×•×œ</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="admin-body">
    <div id="app-container">
        <div class="top-bar">
            <div class="top-bar-header">
                <h1 id="admin-welcome">×“×©×‘×•×¨×“ ×× ×”×œ</h1>
                <button class="button-modern logout-btn" data-action="logout">×”×ª× ×ª×§×•×ª</button>
            </div>
            <hr style="border-color: #e5e7eb; margin: 20px 0;">
            <div class="controls-row">
                <div class="control-group">
                    <label for="date-picker">×ª××¨×™×š ×œ×“×•×—×•×ª:</label>
                    <input type="date" id="date-picker">
                    <button class="button-modern btn-presence" data-action="fetch-reports" data-filter="× ×•×›×—×•×ª">×”×¦×’ × ×•×›×—×•×ª</button>
                    <button class="button-modern btn-shabbat" data-action="fetch-reports" data-filter="×©×‘×ª">×”×¦×’ ×¡×˜×˜×•×¡ ×©×‘×ª</button>
                    <button class="button-modern btn-emergency" data-action="fetch-reports" data-filter="×—×™×¨×•×">×”×¦×’ ×¡×˜×˜×•×¡ ×—×™×¨×•×</button>
                    <button class="button-modern" id="export-excel-btn" style="display:none">ğŸ“¥ ×”×•×¨×“ ×œ××§×¡×œ</button>
                </div>
            </div>
            <hr style="border-color: #e5e7eb; margin: 20px 0;">
            <div class="controls-row">
                <form id="manual-update-form" class="control-group">
                    <label>×¢×“×›×•×Ÿ ×™×“× ×™:</label>
                    <select id="user-select" required><option value="">×‘×—×¨ ××©×ª××©...</option></select>
                    <input type="text" id="manual-status" placeholder="× ×ª×•×Ÿ ×¨××©×™" required>
                    <input type="text" id="manual-status-secondary" placeholder="× ×ª×•×Ÿ ××©× ×™ (×œ×—×™×¨×•×)">
                    <select id="manual-update-type" required>
                        <option value="× ×•×›×—×•×ª">× ×•×›×—×•×ª</option>
                        <option value="×©×‘×ª">×©×‘×ª</option>
                        <option value="×—×™×¨×•×">×—×™×¨×•×</option>
                    </select>
                    <button type="submit" class="button-modern btn-update" data-action="manual-update">×¢×“×›×Ÿ</button>
                </form>
            </div>
        </div>
        <div class="content-table">
            <h3 id="report-title" style="text-align:center; padding-bottom: 20px; color: #374151;"></h3>
            <table id="report-table">
                <thead></thead>
                <tbody><tr><td colspan="3" style="text-align: center; padding: 40px;">×‘×—×¨ ×“×•×— ×œ×”×¦×’×”.</td></tr></tbody>
            </table>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser || loggedInUser.role !== 'Admin') window.location.href = 'index.html';
        document.getElementById('admin-welcome').textContent = '×©×œ×•×, ' + loggedInUser.name;

        const reportColumnsByType = {
            '× ×•×›×—×•×ª': ['×©×', '×¡×˜×˜×•×¡', '×–××Ÿ'],
            '×©×‘×ª': ['×©×', '××™×§×•×', '×–××Ÿ'],
            '×—×™×¨×•×': ['×©×', '××™×§×•×', '×¡×˜×˜×•×¡', '×–××Ÿ']
        };

        let allUsers = [];
        let currentReport = [];
        let currentFilter = '';
        let currentDate = '';

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('date-picker').value = new Date().toISOString().split('T')[0];
            populateUserList();
        });

        document.body.addEventListener('click', async (event) => {
            const action = event.target.dataset.action;
            if (!action) return;

            switch (action) {
                case 'fetch-reports':
                    await fetchReports(event.target.dataset.filter);
                    break;
                case 'logout':
                    logout();
                    break;
            }
        });

        document.getElementById('manual-update-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const data = {
                targetName: form.querySelector('#user-select').value,
                reportData: form.querySelector('#manual-status').value,
                emergencyStatus: form.querySelector('#manual-status-secondary').value,
                updateType: form.querySelector('#manual-update-type').value,
                adminName: loggedInUser.name
            };
            if (!data.targetName || !data.reportData) {
                alert('×™×© ×œ××œ× ×©× ×•× ×ª×•×Ÿ ×¨××©×™.');
                return;
            }

            const button = form.querySelector('button[type="submit"]');
            setLoading(button, true);
            const response = await apiCall('adminUpdateUserStatus', data);
            if (response.success) {
                alert("×”×¢×“×›×•×Ÿ ×‘×•×¦×¢!");
                form.reset();
                document.getElementById('user-select').value = "";
            } else {
                alert(`×©×’×™××”: ${response.message}`);
            }
            setLoading(button, false);
        });

        async function fetchReports(filterType) {
            const tableHead = document.querySelector('#report-table thead');
            const tableBody = document.querySelector('#report-table tbody');
            const reportTitle = document.getElementById('report-title');
            const dateString = document.getElementById('date-picker').value;
            currentFilter = filterType;
            currentDate = dateString;

            reportTitle.innerText = `×˜×•×¢×Ÿ ×“×•×— ${filterType}...`;
            tableBody.innerHTML = '<tr><td colspan="3">×˜×•×¢×Ÿ...</td></tr>';

            const reportRes = await apiCall('getReportsData', { filterType, dateString });
            const usersRes = await apiCall('getAllUserNames');

            if (reportRes.success && usersRes.success) {
                const rawData = reportRes.data;
                allUsers = usersRes.data;

                currentReport = allUsers.map(name => {
                    const match = rawData.find(r => r.name === name);
                    const base = { name, timestamp: match?.timestamp || '××™×Ÿ' };

                    if (filterType === '× ×•×›×—×•×ª') {
                        return { ...base, reportData: match?.reportData || '×œ× ×“×•×•×—' };
                    } else if (filterType === '×©×‘×ª') {
                        return { ...base, location: match?.reportData || '×œ× ×“×•×•×—' };
                    } else if (filterType === '×—×™×¨×•×') {
                        let location = '×œ× ×“×•×•×—';
                        let reportData = '×œ× ×“×•×•×—';

                        if (match?.reportData) {
                            // ××¤×¨×§ ××—×¨×•×–×ª "××™×§×•×: ×‘×‘×™×ª | ×¡×˜×˜×•×¡: ×”×›×œ ×‘×¡×“×¨" ×œ×©× ×™ ×©×“×•×ª × ×¤×¨×“×™×
                            const parts = match.reportData.split('|').map(s => s.trim());
                            parts.forEach(part => {
                                if (part.startsWith('××™×§×•×:')) {
                                    location = part.replace('××™×§×•×:', '').trim();
                                } else if (part.startsWith('×¡×˜×˜×•×¡:')) {
                                    reportData = part.replace('×¡×˜×˜×•×¡:', '').trim();
                                }
                            });
                        }

                        return {
                            ...base,
                            location,
                            reportData
                        };
                    }
                    return base;
                });

                const columns = reportColumnsByType[filterType];
                tableHead.innerHTML = '<tr>' + columns.map(c => `<th>${c}</th>`).join('') + '</tr>';
                tableBody.innerHTML = '';
                reportTitle.innerText = `×“×•×— ${filterType} ×œ×ª××¨×™×š ${dateString}`;
                currentReport.forEach(r => {
                    const row = columns.map(col => {
                        switch (col) {
                            case '×©×': return `<td>${r.name}</td>`;
                            case '×¡×˜×˜×•×¡': return `<td>${r.reportData}</td>`;
                            case '××™×§×•×': return `<td>${r.location || 'â€”'}</td>`;
                            case '×–××Ÿ': return `<td>${r.timestamp}</td>`;
                            default: return `<td></td>`;
                        }
                    }).join('');
                    tableBody.innerHTML += `<tr>${row}</tr>`;
                });
                document.getElementById('export-excel-btn').style.display = 'inline-block';
            } else {
                reportTitle.innerText = '×©×’×™××”';
                tableBody.innerHTML = `<tr><td colspan="3">${reportRes.message || usersRes.message}</td></tr>`;
            }
        }

        document.getElementById('export-excel-btn').addEventListener('click', () => {
            if (!currentReport || currentReport.length === 0) return;

            const columns = reportColumnsByType[currentFilter];
            const wsData = [
                [`×“×•×— ${currentFilter}`],
                [`×ª××¨×™×š:`, currentDate],
                [],
                columns,
                ...currentReport.map(r => columns.map(col => {
                    switch (col) {
                        case '×©×': return r.name;
                        case '×¡×˜×˜×•×¡': return r.reportData;
                        case '××™×§×•×': return r.location || '';
                        case '×–××Ÿ': return r.timestamp;
                        default: return '';
                    }
                }))
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, `×“×•×—_${currentFilter}_${currentDate}.xlsx`);
        });

        async function populateUserList() {
            const response = await apiCall('getAllUserNames');
            if (response.success) {
                const userSelect = document.getElementById('user-select');
                response.data.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    userSelect.appendChild(option);
                });
            }
        }
    </script>
</body>
</html>
